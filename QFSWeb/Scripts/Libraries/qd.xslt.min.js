
var qd=qd||{};qd.xslt=qd.xslt||{};qd.xslt.context=(function(){"use strict";function context(node,variables,rootVariables,functions,emittedNamespaces){var self={variables:variables,functions:functions,getNode:function(){return node;},emittedNamespaces:function(){return emittedNamespaces;},push:function(newNode){return context(newNode||node,variables.clone(),rootVariables,functions,emittedNamespaces);},popLocalVariables:function(){return context(node,rootVariables.clone(),rootVariables,functions,emittedNamespaces);},emitNamespaces:function(namespaces){var prefixes=Object.keys(namespaces);if(!prefixes.length){return self;}
var emitted=Object.create(emittedNamespaces);prefixes.forEach(function(prefix){emitted[prefix]=namespaces[prefix];});return context(node,variables,rootVariables,functions,emitted);}};return self;}
return function(node,variables,functions){return context(node,variables,variables,functions,{});};})();qd.xslt.compileContext=(function(){"use strict";function createCompileContext(namespaceManager){return{clone:function(newNamespaces){return createCompileContext(namespaceManager.clone(newNamespaces));},namespaces:namespaceManager};}
return function(namespaces){return createCompileContext(qd.xmlUtility.namespaceManager(namespaces));}})();qd.xslt.variableResolver=(function(){"use strict";function createVariableContext(parentContext){var variables={};function hasVariable(name){return name in variables||(parentContext&&parentContext.hasVariable(name));}
var resolver={clone:function(){return createVariableContext(resolver);},hasVariable:hasVariable,setVariable:function(name,value){if(hasVariable(name)){throw new Error('variable already defined in this scope: '+name);}
variables[name]=value;},getVariable:function(name){if(name in variables){return variables[name];}
if(!parentContext){throw new Error('undefined variable reference: '+name);}
return parentContext.getVariable(name);}};return resolver;}
return function(){return createVariableContext();};})();var qd=qd||{};qd.xslt=qd.xslt||{};qd.xslt.domBuilder=(function(qd,window){"use strict";var xu=qd.xmlUtility;function domBuilder(){function createDocument(){var parser,xml;try{if(window.DOMParser){parser=new DOMParser();xml=parser.parseFromString('<n />','text/xml');xml.removeChild(xml.documentElement);return xml;}}catch(e){}
throw new Error('unable to create XML document');}
function convertElement(document,node){var el=document.createElementNS(node.namespaceUri,node.name),attrs=node.attributes,nses=node.namespaces,attr;Object.keys(nses).forEach(function(k){el.setAttributeNS(xu.nsXmlns,'xmlns'+(k?':'+k:''),nses[k]);});Object.keys(attrs).forEach(function(k){attr=attrs[k];if(attr.namespaceUri){el.setAttributeNS(attr.namespaceUri,attr.name,attr.value);}else{el.setAttribute(attr.name,attr.value);}});convertAndAppend(el,document,node.children);return el;}
function convertDocumentFragment(document,node){var df=document.createDocumentFragment();convertAndAppend(df,document,node.children);return df;}
function convertNode(document,node){switch(node.type){case xu.DOM_ELEMENT_NODE:return convertElement(document,node);case xu.DOM_TEXT_NODE:return document.createTextNode(node.value);case xu.DOM_DOCUMENT_FRAGMENT_NODE:return convertDocumentFragment(document,node);case xu.DOM_PROCESSING_INSTRUCTION_NODE:return document.createProcessingInstruction(node.name,node.data);}
return null;}
function identity(val){return!!val;}
function convertAndAppend(target,document,nodes){nodes.map(function(n){return convertNode(document,n);}).filter(identity).forEach(function(n){target.appendChild(n);});}
function fromRawNodes(nodes,options){var optionsNormalized=options||{},doc=createDocument(),target=optionsNormalized.fragment?doc.createDocumentFragment():doc;convertAndAppend(target,doc,nodes);return target;}
function valueNode(nodeType,value){return{type:nodeType,value:value};}
function textNode(text){return valueNode(xu.DOM_TEXT_NODE,text);}
function cdataNode(value){return valueNode(xu.DOM_CDATA_SECTION_NODE,value);}
function attributeNode(name,localName,namespace,value){return{type:xu.DOM_ATTRIBUTE_NODE,name:name,localName:localName,namespaceUri:namespace,value:value};}
function elementNode(name,namespaceUri,namespaces,attributes,children){return{type:xu.DOM_ELEMENT_NODE,name:name,namespaceUri:namespaceUri,namespaces:namespaces,attributes:attributes,children:children};}
function buildNamespaceMap(namespaces){var map={};namespaces.forEach(function(ns){map[ns.prefix]=ns.uri;});return map;}
function buildAttributeMap(attributes){var map={};attributes.forEach(function(a){map['{'+(a.namespaceUri||'')+'}'+a.localName]=a;});return map;}
function buildElementNode(node){var namespaces=xu.getNamespaces(node),attributes=toRawNodes(xu.getAttributes(node).filter(function(a){return a.namespaceURI!==xu.nsXmlns;})),children=toRawNodes(xu.getChildNodes(node));return elementNode(node.nodeName,node.namespaceURI||'',buildNamespaceMap(namespaces),buildAttributeMap(attributes),children);}
function documentFragmentNode(node){return{type:xu.DOM_DOCUMENT_FRAGMENT_NODE,children:toRawNodes(xu.getChildNodes(node))};}
function processingInstructionNode(name,data){return{type:xu.DOM_PROCESSING_INSTRUCTION_NODE,name:name,data:data};}
function toRawNode(domNode){switch(domNode.nodeType){case xu.DOM_TEXT_NODE:return textNode(xu.textValue(domNode));case xu.DOM_CDATA_SECTION_NODE:return cdataNode(xu.textValue(domNode));case xu.DOM_ATTRIBUTE_NODE:return attributeNode(domNode.nodeName,domNode.localName,domNode.namespaceURI||'',xu.textValue(domNode));case xu.DOM_ELEMENT_NODE:return buildElementNode(domNode);case xu.DOM_DOCUMENT_FRAGMENT_NODE:return documentFragmentNode(domNode);case xu.DOM_PROCESSING_INSTRUCTION_NODE:return processingInstructionNode(domNode.target,domNode.data);}
return null;}
function toRawNodes(domNodes){return domNodes.map(toRawNode).filter(function(n){return n;});}
return{fromRawNodes:fromRawNodes,toRawNodes:toRawNodes,textNode:textNode,attributeNode:attributeNode,elementNode:elementNode,processingInstructionNode:processingInstructionNode};}
return domBuilder;})(qd,typeof window!=="undefined"?window:{});var qd=qd||{};qd.xslt=qd.xslt||{};(function(xslt){"use strict";var xu=qd.xmlUtility,nsXsl="http://www.w3.org/1999/XSL/Transform",XPathParser=xpath.XPathParser;function getStylesheetRoot(stylesheet){var root=stylesheet;if(!root){throw new Error("Argument missing: stylesheet");}
if(xu.isDocumentNode(root)){root=xu.firstElementChild(stylesheet);}
if(!root){throw new Error("Unable to locate stylesheet root.");}
if(root.namespaceURI!==nsXsl||root.localName!=='stylesheet'){throw new Error("Unexpected stylesheet root element: "+root.nodeName);}
return root;}
function compile(stylesheet){var root=getStylesheetRoot(stylesheet),xpathParser=new XPathParser(),domBuilder=xslt.domBuilder(),executor=xslt.stylesheetCompiler.compile(xpathParser,root,domBuilder);function transformRaw(node,options){return executor.execute(node,options);}
return{templates:executor.templates,transform:function(node,options){return domBuilder.fromRawNodes(transformRaw(node,options));},transformRaw:transformRaw};}
xslt.compile=compile;})(qd.xslt);var qd=qd||{};qd.xslt=qd.xslt||{};qd.xslt.stylesheetCompiler=(function(xslt){"use strict";var xu=qd.xmlUtility,nsXsl="http://www.w3.org/1999/XSL/Transform";var XPathContext=xpath.XPathContext,XNodeSet=xpath.XNodeSet;function compile(xpathParser,stylesheet,domBuilder){var ssheetParser=xslt.stylesheetParser(xpathParser),templateParser=xslt.templateParser(xpathParser),templates=templateParser.parseTemplates(stylesheet);function parseXPath(xpath){try{return xpathParser.parse(xpath);}catch(e){throw new Error("Invalid XPath: "+xpath);}}
function flatMap(array,action){return Array.prototype.concat.apply([],array.map(action));}
function find(array,predicate){for(var i=0;i<array.length;i+=1){if(predicate(array[i])){return array[i];}}
return null;}
function any(array,predicate){for(var i=0;i<array.length;i+=1){if(predicate(array[i])){return true;}}
return false;}
function evaluate(xpath,context){return xpath.evaluate(context);}
function selectNodes(xpath,context,sort){var nSet=evaluate(xpath,context);return sort?nSet.toArray():nSet.toUnsortedArray();}
function evaluateString(xpath,execContext){return String(evaluate(xpath,execContext).stringValue());}
function evaluateBoolean(xpath,context){return evaluate(xpath,context).booleanValue();}
function updateContext(node,context){var namespaces=xu.getNamespaces(node);return namespaces.length?context.clone(namespaces):context;}
function combineContexts(compileContext,runtimeContext){var ct=new XPathContext();ct.expressionContextNode=runtimeContext.getNode();ct.namespaceResolver=compileContext.namespaces;ct.variableResolver=runtimeContext.variables;ct.functionResolver=runtimeContext.functions||ct.functionResolver;return ct;}
function cloneExpressionContext(context,node){var ct=new XPathContext();ct.expressionContextNode=node;ct.namespaceResolver=context.namespaceResolver;return ct;}
function isChildTest(xpath){return xpath.type==='StepExpr'&&xpath.axis==='child'&&!(xpath.predicates.length);}
function isMatch(xpath,context){var matchNode=context.expressionContextNode,current=matchNode,result;if(isChildTest(xpath)&&current.parentNode){return xpath.test.test(context);}
while(current){result=selectNodes(xpath,context,false);if(any(result,function(n){return n===matchNode})){return true;}
current=current.parentNode||current.ownerElement;context=cloneExpressionContext(context,current);}
return false;}
function findFirstMatch(priorityTemplates,context){var match=find(priorityTemplates,function(pt){return isMatch(pt.match,combineContexts(pt.template.compileContext,context));});return match&&match.template;}
function findMatchTemplate(context,mode){var modeTemplates=templates.match[mode],match=modeTemplates&&findFirstMatch(modeTemplates,context);return match||null;}
function elementNode(name,namespaceUri,namespaces,attributes,contents){var children=[],finishedAttributes=false;contents.forEach(function(c){if(c.type===xu.DOM_ATTRIBUTE_NODE){if(finishedAttributes){throw new Error('error generating "'+name+'" element. attributes must occur before other nodes.');}
attributes[fullNodeName(c.namespaceUri,c.localName)]=c;}else{finishedAttributes=true;children.push(c);}});return domBuilder.elementNode(name,namespaceUri,namespaces,attributes,children);}
function defaultTemplate(mode,context){var node=context.getNode();if(xu.isTextNode(node)){return[domBuilder.textNode(node.textContent)];}
return flatMap(xu.getChildNodes(node),function(n){return applyTemplates(context.push(n),mode);});}
function evaluateContentVariable(definition,runtimeContext){var result=definition.template(runtimeContext),domNode=domBuilder.fromRawNodes(result,{fragment:true}),ns=new XNodeSet();ns.add(domNode);return ns;}
function evaluateVariable(definition,runtimeContext,execContext){if(definition.select){return evaluate(definition.select,execContext);}
if(definition.template){return evaluateContentVariable(definition,runtimeContext);}
return new XString('');}
function executeXslTemplate(template,context,params){var newContext=context.popLocalVariables(),execContext=combineContexts(template.compileContext,newContext);template.params.forEach(function(p){var name=p.name,value=name in params?params[name]:evaluateVariable(p,newContext,execContext);newContext.variables.setVariable(name,value);});return template.action(newContext);}
function applyTemplates(context,mode,params){var template=findMatchTemplate(context,mode);if(template){return executeXslTemplate(template,context,params||{});}
return defaultTemplate(mode,context);}
function evaluateWithParams(withParams,runtimeContext,execContext){var values={};withParams.forEach(function(p){values[p.name]=evaluateVariable(p,runtimeContext,execContext);});return values;}
function compileVariableTemplate(variable,compileContext){variable.template=(!variable.select&&variable.node.childNodes.length&&compileTemplate(variable.node,compileContext))||null;}
function compileVariableTemplates(variables,compileContext){variables.forEach(function(wp){compileVariableTemplate(wp,compileContext);});}
function xslApplyTemplates(node,compileContext){var parsed=ssheetParser.parseXslApplyTemplates(node);compileVariableTemplates(parsed.withParams,compileContext);return function(context){var execContext=combineContexts(compileContext,context),nodes=parsed.select?selectNodes(parsed.select,execContext,true):xu.getChildNodes(context.getNode()),params=evaluateWithParams(parsed.withParams,context,execContext);return flatMap(nodes,function(n){return applyTemplates(context.push(n),parsed.mode,params);});};}
function getTemplateByName(name){return templates.named[name];}
function xslCallTemplate(node,compileContext){var parsed=ssheetParser.parseXslCallTemplate(node),template=getTemplateByName(parsed.name);if(!template){throw new Error('Invalid template name:  '+name);}
compileVariableTemplates(parsed.withParams,compileContext);return function(context){var execContext=combineContexts(compileContext,context),params=evaluateWithParams(parsed.withParams,context,execContext);return executeXslTemplate(template,context,params);};}
function xslForEach(node,compileContext){var select=node.getAttribute('select'),parsed=select&&parseXPath(select),template=select&&compileTemplate(node,compileContext);if(!select){throw new Error('select attribute unspecified on for-each');}
return function(context){var nodes=selectNodes(parsed,combineContexts(compileContext,context),true);return flatMap(nodes,function(n){return template(context.push(n));});};}
function xslIf(node,compileContext){var test=node.getAttribute('test'),parsed=test&&parseXPath(test),template=parsed&&compileTemplate(node,compileContext);if(!test){throw new Error('test attribute unspecified on if');}
return function(context){var result=evaluateBoolean(parsed,combineContexts(compileContext,context));if(result){return template(context);}
return[];}}
function emptyTemplate(){return[];}
function xslEmpty(){return emptyTemplate;}
function xslValueOf(node,compileContext){var parsed=ssheetParser.parseXslValueOf(node);return function(context){var value=evaluateString(parsed.select,combineContexts(compileContext,context));return value?[domBuilder.textNode(value)]:[];};}
function xslChoose(node,compileContext){var chooseDef=ssheetParser.parseXslChoose(node),whens=chooseDef.whens.map(function(w){return{test:w.test,template:compileTemplate(w.node,compileContext)}}),otherwiseTemplate=chooseDef.otherwise&&compileTemplate(chooseDef.otherwise,compileContext);return function(context){var match=find(whens,function(w){return evaluateBoolean(w.test,combineContexts(compileContext,context));});if(match){return match.template(context);}
if(otherwiseTemplate){return otherwiseTemplate(context);}
return[];}}
function getNamespaces(namespaceManager){return namespaceManager.namespaceMap();}
function compileAvtPart(part){if(part.type==="text"){return function(){return part.value;};}
if(part.type==="xpath"){return function(execContext){return evaluateString(part.value,execContext);}}
throw new Error('Unexpected attribute part type: '+part.type);}
function compileAvtParts(parts){var partsCompiled=parts.map(compileAvtPart);return function(execContext){return partsCompiled.map(function(part){return part(execContext);}).join('');};}
function compileAvt(value){return compileAvtParts(ssheetParser.parseAttributeValueTemplate(value));}
function splitName(name){var parts=name.split(':');if(parts.length===0||parts.length>2){throw new Error('Invalid element name: '+name);}
return parts.length===1?['',name]:parts;}
function xslElementNamespaces(contextNamespaces,prefix,namespace){if(!namespace||contextNamespaces.getNamespace(prefix)===namespace){return contextNamespaces;}
return contextNamespaces.clone([{prefix:prefix,uri:namespace}]);}
function diffNamespaces(contextNamespaces,emitted){var diffed={};Object.keys(contextNamespaces).filter(function(prefix){return!(prefix in emitted)||contextNamespaces[prefix]!==emitted[prefix];}).forEach(function(prefix){diffed[prefix]=contextNamespaces[prefix];});return diffed;}
function xslElement(node,compileContext){var parsed=ssheetParser.parseXslElement(node),compiledName=compileAvt(parsed.name),compiledNamespace=(parsed.namespace||parsed.namespace==='')&&compileAvt(parsed.namespace),ctxNamespaces=compileContext.namespaces,template=compileTemplate(node,compileContext);return function(context){var execContext=combineContexts(compileContext,context);var name=compiledName(execContext);var nameParts=splitName(name);var prefix=nameParts[0];var namespace=compiledNamespace?compiledNamespace(execContext):ctxNamespaces.getNamespace(prefix);var nsm=xslElementNamespaces(ctxNamespaces,prefix,namespace);var namespaceObj=getNamespaces(nsm);var elNamespaces=diffNamespaces(namespaceObj,context.emittedNamespaces());var content=template(context.emitNamespaces(elNamespaces));return elementNode(namespace?name:nameParts[1],namespace,elNamespaces,{},content);};}
function determineAttributeNamespace(prefix,namespaces,compiledNs,execContext){if(compiledNs){return compiledNs(execContext);}
if(prefix){return namespaces.getNamespace(prefix);}
return'';}
function attributeStringValue(nodes){var textNodes=nodes.filter(function(n){return n.type===xu.DOM_TEXT_NODE;});if(textNodes.length!==nodes.length){throw new Error('Attributes can only contain text.');}
return textNodes.map(function(n){return n.value;}).join('');}
function xslAttribute(node,compileContext){var parsed=ssheetParser.parseXslAttribute(node),compiledName=compileAvtParts(parsed.name),compiledNs=parsed.namespace&&compileAvtParts(parsed.namespace),ctxNamespaces=compileContext.namespaces,template=compileTemplate(node,compileContext);return function(context){var execContext=combineContexts(compileContext,context),name=compiledName(execContext),nameParts=splitName(name),namespace=determineAttributeNamespace(nameParts[0],ctxNamespaces,compiledNs,execContext),content=template(context),contentStr=attributeStringValue(content);return domBuilder.attributeNode(name,nameParts[1],namespace,contentStr);};}
function xslVariable(node,compileContext){var parsed=ssheetParser.parseXslVariable(node,ssheetParser.parseXslVariable,compileContext);compileVariableTemplate(parsed,compileContext);return function(context){var execContext=combineContexts(compileContext,context),val=evaluateVariable(parsed,context,execContext);context.variables.setVariable(parsed.name,val);return[];};}
function xslText(node){var parsed=ssheetParser.parseXslText(node);return parsed?function(){return domBuilder.textNode(parsed);}:emptyTemplate;}
function xslCopyOf(node,compileContext){var parsed=ssheetParser.parseXslCopyOf(node);return function(context){var execContext=combineContexts(compileContext,context),nodes=selectNodes(parsed.select,execContext,true),rawNodes=domBuilder.toRawNodes(nodes);return(rawNodes.length===1&&rawNodes[0].type===xu.DOM_DOCUMENT_FRAGMENT_NODE)?rawNodes[0].children:rawNodes;};}
function xslCopy(node,compileContext){var template=compileTemplate(node,compileContext),ctxNamespaces=compileContext.namespaces;return function(context){var node=context.getNode(),content;if(xu.isDocumentNode(node)){return template(context);}
if(xu.isElement(node)){var nameParts=splitName(node.nodeName);var prefix=nameParts[0];var allNamespaces=getNamespaces(xslElementNamespaces(ctxNamespaces,prefix,node.namespaceURI));var elNamespaces=diffNamespaces(allNamespaces,context.emittedNamespaces());content=template(context.emitNamespaces(elNamespaces));return elementNode(node.nodeName,node.namespaceURI,elNamespaces,{},content);}
if(xu.isAttribute(node)){return domBuilder.attributeNode(node.nodeName,node.localName||node.nodeName,node.namespaceURI,node.value);}
if(xu.isTextNode(node)||xu.isCData(node)){return domBuilder.textNode(xu.textValue(node));}
if(xu.isProcessingInstruction(node)){return domBuilder.processingInstructionNode(node.target,node.data);}};}
var xslNodeHandlers={'apply-templates':xslApplyTemplates,'attribute':xslAttribute,'call-template':xslCallTemplate,'choose':xslChoose,'copy':xslCopy,'copy-of':xslCopyOf,'element':xslElement,'for-each':xslForEach,'if':xslIf,'text':xslText,'value-of':xslValueOf,'variable':xslVariable};function compileXslNode(node,compileContext){var handler=xslNodeHandlers[node.localName]||xslEmpty;return handler(node,compileContext);}
function compileLiteralAttribute(attr){var avt=compileAvt(attr.value);return function(execContext){return domBuilder.attributeNode(attr.nodeName,attr.localName,attr.namespaceURI||'',avt(execContext));};}
function fullNodeName(namespace,localName){return'{'+(namespace||'')+'}'+localName;}
function compileLiteralAttributes(element){var compiled=xu.getAttributes(element).filter(function(a){return a.namespaceURI!==xu.nsXmlns;}).map(compileLiteralAttribute);return function(execContext){var attrs={},ea;compiled.forEach(function(a){ea=a(execContext);attrs[fullNodeName(ea.namespaceUri,ea.localName)]=ea;});return attrs;};}
function compileElementLiteral(xslNode,compileContext){var name=xslNode.nodeName,namespace=xslNode.namespaceURI,template=compileTemplate(xslNode,compileContext),compiledAttributes=compileLiteralAttributes(xslNode);return function(context){var namespaces=getNamespaces(compileContext.namespaces),execContext=combineContexts(compileContext,context),attributes=compiledAttributes(execContext);var elNamespaces=diffNamespaces(namespaces,context.emittedNamespaces());var contents=template(context.emitNamespaces(elNamespaces));return[elementNode(name,namespace,elNamespaces,attributes,contents)];};}
function xslTextLiteral(xslNode){if(xslt.utility.isWhitespaceTextNode(xslNode)){return emptyTemplate;}
var value=qd.xmlUtility.textValue(xslNode);return function(){return domBuilder.textNode(value);};}
function literal(node,compileContext){if(xu.isElement(node)){return compileElementLiteral(node,compileContext);}
if(xu.isTextNode(node)||xu.isCData(node)){return xslTextLiteral(node);}
return xslEmpty();}
function compileNode(node,compileContext){var newContext=updateContext(node,compileContext);if(node.namespaceURI===nsXsl){return compileXslNode(node,newContext);}else{return literal(node,newContext);}}
function compileTemplate(node,compileContext){var newContext=updateContext(node,compileContext),compiled=xu.getChildNodes(node).map(function(n){return compileNode(n,newContext);});return function(context){var newRuntimeContext=context.push();return flatMap(compiled,function(c){return c(newRuntimeContext);}).filter(function(v){return v!==null&&typeof v!=='undefined';});}}
function execute(node,options){var variables=qd.xslt.variableResolver(),functions=(options&&options.functions)||null,context=qd.xslt.context(node,variables,functions);return applyTemplates(context,null);}
function buildCompileContext(){var namespaces=xu.getNamespaces(stylesheet);return xslt.compileContext(namespaces);}
function buildProcessor(){var compileContext=buildCompileContext();templates.all.forEach(function(template){template.compileContext=updateContext(template.node,compileContext);template.action=compileTemplate(template.node,compileContext);template.params.forEach(function(p){compileVariableTemplate(p,template.compileContext);});});return{templates:templates,execute:execute}}
return buildProcessor();}
return{compile:compile};})(qd.xslt);var qd=qd||{};qd.xslt=qd.xslt||{};qd.xslt.stylesheetParser=(function(xslt){"use strict";var xu=qd.xmlUtility,nsXsl="http://www.w3.org/1999/XSL/Transform";function stylesheetParser(xpathParser){function parseXPath(expression){return xpathParser.parse(expression);}
function parseXslElement(node){var name=node.getAttribute('name'),namespace=node.hasAttribute('namespace')&&node.getAttribute('namespace');if(!name){throw new Error('name attribute unspecified on xsl:element');}
return{name:name,namespace:namespace};}
function parseXslValueOf(node){var select=node.getAttribute('select'),parsed=select&&parseXPath(select);if(!select){throw new Error("select attribute unspecified on xsl:value-of");}
return{select:parsed};}
function parseXslWhen(node){var test=node.getAttribute('test'),parsed=test&&parseXPath(test);if(!test){throw new Error("missing test attribute on xsl:when");}
return{test:parsed,node:node};}
function parseXslChoose(node){var elements=xu.getChildElements(node),whens=[],otherwise;elements.forEach(function(e){if(e.namespaceURI===nsXsl){if(e.localName==='when'){if(otherwise){throw new Error('xsl:when cannot occur after xsl:otherwise');}
whens.push(parseXslWhen(e));return;}
if(e.localName==='otherwise'){if(otherwise){throw new Error('otherwise can only occur once');}
otherwise=e;return;}}
throw new Error('Invalid element in choose: '+e.nodeName);});if(whens.length===0){throw new Error('choose must contain at least one when');}
return{whens:whens,otherwise:otherwise};}
function parseAvtXPathComponent(start,value){var innerStart=start+1,end=value.indexOf('}',innerStart),expr,parsed,err;if(end===-1){throw new Error('Invalid attribute value; expected "}":');}
expr=value.substring(innerStart,end);try{parsed=parseXPath(value.substring(innerStart,end));}catch(e){err=new Error('Invalid XPath expression "'+expr+'" in attribute: '+value);err.parseError=e;throw err;}
return{value:{type:'xpath',value:parsed},end:end+1};}
function parseAvtLiteralComponent(start,value){var pos;for(pos=start;pos<value.length;pos+=1){if(value.charAt(pos)==='}'){if(value.charAt(pos+1)==='}'){pos+=1;continue;}
throw new Error('Invalid attribute value; unexpected "}": '+value);}
if(value.charAt(pos)==='{'){if(value.charAt(pos+1)==='{'){pos+=1;continue;}
break;}}
return{value:{type:'text',value:value.substring(start,pos).replace(/{{/g,'{').replace(/}}/g,'}')},end:pos};}
function parseAvtComponent(start,value){if(value.charAt(start)==='{'&&value.charAt(start+1)!=='{'){return parseAvtXPathComponent(start,value);}
return parseAvtLiteralComponent(start,value);}
function parseAttributeValueTemplate(value){var components=[],pos=0,comp;while(pos<value.length){comp=parseAvtComponent(pos,value);components.push(comp.value);pos=comp.end;}
return components;}
function parseXslAttribute(node){var name=node.getAttribute('name'),namespace=node.getAttribute('namespace')||null;if(!name){throw new Error('name attribute unspecified on xsl:attribute');}
return{name:parseAttributeValueTemplate(name),namespace:namespace&&parseAttributeValueTemplate(namespace)};}
function parseVariableLikeNode(nodeName,node){var name=node.getAttribute('name'),select=node.hasAttribute('select')?node.getAttribute('select'):null,selectExpr=select!==null&&parseXPath(select);if(!name){throw new Error('name attribute unspecified on '+nodeName);}
return{name:name,select:selectExpr,node:node};}
var parseXslParam=parseVariableLikeNode.bind(null,'xsl:param'),parseXslWithParam=parseVariableLikeNode.bind(null,'xsl:with-param');function parseParams(templateNode){var childNodes=xu.getChildNodes(templateNode).filter(xslt.utility.isNotWhitespaceOrComment),params=[],finishedParams=false;childNodes.forEach(function(n){if(n.namespaceURI===nsXsl&&n.localName==='param'){if(finishedParams){throw new Error('xsl:param must precede all other nodes');}
params.push(parseXslParam(n));}else{finishedParams=true;}});return params;}
function parseXslTemplate(node){var match=node.getAttribute('match'),priority=node.getAttribute('priority');return{match:match?parseXPath(match):null,name:node.getAttribute('name')||null,mode:node.getAttribute('mode')||null,priority:priority?parseFloat(priority):null,params:parseParams(node),node:node};}
function parseWithParams(nodes){return nodes.filter(function(n){return n.namespaceURI===nsXsl&&n.localName==='with-param';}).map(parseXslWithParam);}
function parseXslApplyTemplates(node){var mode=node.getAttribute('mode')||null,select=node.getAttribute('select'),selectXPath=select&&parseXPath(select),nodes=xu.getChildNodes(node),withParams=parseWithParams(nodes);return{mode:mode,select:selectXPath,withParams:withParams};}
function parseXslCallTemplate(node){var name=node.getAttribute('name'),nodes=xu.getChildNodes(node),withParams=parseWithParams(nodes);if(!name){throw new Error('template name unspecified on xsl:call-template');}
return{name:name,withParams:withParams};}
function parseXslText(node){var parts=[];xu.getChildNodes(node).forEach(function(n){if(xu.isTextNode(n)||xu.isCData(n)){parts.push(xu.textValue(n));}else if(xu.isElement(n)){throw new Error("xsl:text cannot contain other elements. Element found: "+n.nodeName);}});return String.prototype.concat.apply("",parts);}
function parseXslCopyOf(node){var select=node.getAttribute('select'),selectXPath=select&&parseXPath(select);if(!select){throw new Error('select unspecified on xsl:copy-of');}
return{select:selectXPath};}
return{parseXslElement:parseXslElement,parseXslValueOf:parseXslValueOf,parseXslChoose:parseXslChoose,parseAttributeValueTemplate:parseAttributeValueTemplate,parseXslAttribute:parseXslAttribute,parseXslVariable:parseVariableLikeNode.bind(null,'xsl:variable'),parseXslParam:parseXslParam,parseXslWithParam:parseVariableLikeNode.bind(null,'xsl:with-param'),parseXslTemplate:parseXslTemplate,parseXslApplyTemplates:parseXslApplyTemplates,parseXslCallTemplate:parseXslCallTemplate,parseXslText:parseXslText,parseXslCopyOf:parseXslCopyOf};}
return stylesheetParser;})(qd.xslt);var qd=qd||{};qd.xslt.templateParser=(function(){"use strict";var xu=qd.xmlUtility,nsXsl="http://www.w3.org/1999/XSL/Transform";var XPath=xpath.XPath,Utilities=xpath.Utilities,Step=xpath.Step,BarOperation=xpath.BarOperation,NodeTest=xpath.NodeTest;function templateParser(xpathParser){var stylesheetParser=qd.xslt.stylesheetParser(xpathParser);function buildNamedTemplateMap(templates){return templates.reduce(function(last,template){var name=template.name;if(name in last){throw new Error("Duplicate template name: "+name);}
last[name]=template;return last;},{});}
function priorityTemplate(template,priority,match){return{template:template,priority:priority,match:match};}
function getExpressionParts(expression){if(Utilities.instance_of(expression,BarOperation)){return getExpressionParts(expression.lhs).concat(getExpressionParts(expression.rhs));}
return[new XPath(expression)];}
function analyzeExpression(expr){var locPath=expr.locationPath,steps=locPath.steps,firstStep=steps[0],isSimple=!locPath.absolute&&steps.length===1&&(firstStep.axis===Step.CHILD||firstStep.axis===Step.ATTRIBUTE)&&firstStep.predicates.length===0;return{isSimple:isSimple,firstStep:firstStep};}
function getExpressionPriority(expr){var analysis=analyzeExpression(expr);if(analysis.isSimple){var step=analysis.firstStep,stepType=step.nodeTest.type;if(stepType===NodeTest.NAMETESTQNAME){return 0;}
if(stepType===NodeTest.NAMETESTPREFIXANY){return-0.25;}
if(stepType===NodeTest.NAMETESTANY||stepType===NodeTest.NODE||stepType===NodeTest.PI||stepType===NodeTest.TEXT||stepType===NodeTest.COMMENT){return-0.5;}}
return 0.5;}
function splitMatchTemplate(template){if(template.priority!==null){return[priorityTemplate(template,template.priority,template.match)];}
var parts=getExpressionParts(template.match.expression);return parts.map(function(expr){return priorityTemplate(template,getExpressionPriority(expr.expression),expr);});}
function buildMatchTemplateMap(templates){var modeMap=templates.reduce(function(last,template){var mode=template.mode,entries=last[mode];if(!entries){entries=[];last[mode]=entries;}
Array.prototype.push.apply(entries,splitMatchTemplate(template));return last;},{});Object.keys(modeMap).forEach(function(mode){var entries=modeMap[mode];entries.sort(function(l,r){return r.priority-l.priority;});});return modeMap;}
function parseTemplates(stylesheet){var allTemplates=xu.getChildElements(stylesheet,'template',nsXsl).map(stylesheetParser.parseXslTemplate),matchTemplates=allTemplates.filter(function(t){return t.match;}),matchTemplateMap=buildMatchTemplateMap(matchTemplates),namedTemplates=allTemplates.filter(function(t){return t.name;}),namedTemplateMap=buildNamedTemplateMap(namedTemplates);return{all:allTemplates,named:namedTemplateMap,match:matchTemplateMap};}
return{parseTemplates:parseTemplates};}
return templateParser;})();﻿var qd=qd||{};qd.xslt=qd.xslt||{};(function(qd,xslt){"use strict";var regexWhitespace=/^[ \r\n\t]*$/;function isWhitespaceTextNode(node){return(qd.xmlUtility.isTextNode(node)||qd.xmlUtility.isCData(node))&&regexWhitespace.test(qd.xmlUtility.textValue(node));}
function isWhitespaceOrComment(node){return isWhitespaceTextNode(node)||qd.xmlUtility.isComment(node);}
function not(func){return function(){return!func.apply(null,arguments);}}
xslt.utility={isWhitespaceTextNode:isWhitespaceTextNode,isWhitespaceOrComment:isWhitespaceOrComment,isNotWhitespaceOrComment:not(isWhitespaceOrComment)};})(qd,qd.xslt);